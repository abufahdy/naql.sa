<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>إصدار بطاقة سائق</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; text-align: center; margin: 40px; }
    input, select, button { margin: 10px; padding: 10px; font-size: 16px; }
    canvas { margin-top: 20px; }
  </style>
</head>
<body>

  <h2>إصدار بطاقة سائق</h2>

  <input id="driver_id" placeholder="هوية السائق" /><br>
  <input id="first_name" placeholder="الاسم الأول" /><br>
  <input id="last_name" placeholder="اسم العائلة" /><br>
  <select id="card_type">
    <option>نقل البضائع على الحساب الخاص</option>
    <option>نقل الركاب</option>
  </select><br>

  <button onclick="issueCard()">إصدار البطاقة</button>

  <p id="message" style="color: green;"></p>
  <canvas id="qrcode"></canvas>

  <script>
    const supabase = window.supabase.createClient(
      "https://vhmwdfshqrwasfopqatt.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZobXdkZnNocXJ3YXNmb3BxYXR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzYzMTIsImV4cCI6MjA2NjIxMjMxMn0.PU2A9MBGplvnvb7skliZc1BjhzzFFm8CmdUjAi9k6Fc"
    );

    async function issueCard() {
      const driver_id = document.getElementById('driver_id').value.trim();
      const first_name = document.getElementById('first_name').value.trim();
      const last_name = document.getElementById('last_name').value.trim();
      const card_type = document.getElementById('card_type').value;

      if (!driver_id || !first_name || !last_name || !card_type) {
        alert("يرجى تعبئة جميع الحقول");
        return;
      }

      const card_number = Math.floor(100000000 + Math.random() * 900000000);
      const today = new Date().toISOString().split('T')[0];
      const nextYear = new Date();
      nextYear.setFullYear(nextYear.getFullYear() + 1);
      const expiry = nextYear.toISOString().split('T')[0];

      const { error } = await supabase.from('cart').insert([{
        card_number,
        driver_id,
        first_name,
        last_name,
        issue_date: today,
        expiry_date: expiry,
        card_type
      }]);

      if (error) {
        document.getElementById('message').style.color = "red";
        document.getElementById('message').textContent = "حدث خطأ: " + error.message;
        console.error("Supabase error:", error);
        return;
      }

      document.getElementById('message').style.color = "green";
      document.getElementById('message').textContent = "تم إصدار البطاقة بنجاح ✅";

      const qrLink = `https://ahmedcards.infinityfreeapp.com/card/?card=${card_number}`;
      QRCode.toCanvas(document.getElementById('qrcode'), qrLink, function (err) {
        if (err) console.error("QR error:", err);
      });
    }
  </script>

</body>
</html>
